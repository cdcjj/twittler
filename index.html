<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Twittler</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="timestamp.js"></script>
    <script src="jquery.timeago.js"></script>
  </head>
  <body>

    <!-- Header -->

    <header>
      <h1>
        <img class="logo" src="images/logo.jpg" alt="Twittler corgi logo">Twittler
      </h1>
      <h3>Welcome, Visitor!</h3>
      <h4 class="dateToday"></h4>
    </header>

    <section>
      <div class="allUsers">See All Users</div>
    </section>
    <!-- New Tweet Alert -->
    <section> 
      <div id='newTweets'><strong>No new tweets</strong></div>
    </section>

    <!-- Tweet Feed -->
    <section class="feed master"></section>

    <!-- User Feed -->
    <section class="feed user-feed"></section>

    <script>
    window.visitor;

      $(document).ready(function(){
        // jQuery("time.timeago").timeago();

        // DOM shortcuts
        var $tweetfeed = $('.master');
        var $newTweets = $('#newTweets');
        var $userFeed = $('.user-feed');
        var $allUsers = $('.allUsers');
        var tweetsArray;
        var seeAll = true;


        if (seeAll) {
          tweetsArray = streams.home;
          $allUsers.hide();
        }

        var totalPosted = tweetsArray.length;
        var newTweetTotal = 0;

        var today = function() {
          var todayDate = formatDate(new Date());
          $('.dateToday').text(todayDate);

          setTimeout(function() {
            today();
          }, 7.2e+6);
        }
        today();        

        // Displays 11 tweets at page load
        var displayEachTweet = function(oneTweet, all) {
          var tweet = oneTweet;

          // var timestamp =
          var $tweet = $('<div class="tweets group"><img class="avatar" src="images/' + tweet.user + 
            '.jpg" alt="twittler user images">' + '<a href="#" class="user">@' + tweet.user + 
            ':<br></a><p class="message">' + tweet.message + 
            '</p><br><p class="timestamp">' + tweet.created_at + 
            '</p></div>');

          if (all) {
            $tweet.prependTo($tweetfeed);
          }else {
            $tweet.prependTo($userFeed);
          }

          $tweet.animate({'opacity' : '1'}, 1000);

        };

        var displayTweets = function(tweetArr, allTw) {
          var index = tweetArr.length - 1;
          while (index >= 0) {
            displayEachTweet(tweetArr[index], allTw);
            index -= 1;
          }

          if (allTw) {
            $userFeed.hide();
          }
        }

        displayTweets(tweetsArray, seeAll);
       

        // Initialize checkNewTweets();
        var checkNewTweets = function() {
          // Check current tweet count;
          newTweetTotal = tweetsArray.length;
          notPostedTw = newTweetTotal - totalPosted;

          // display or hide newTweet message
          if (notPostedTw > 0) {
            $newTweets.fadeIn();
            $newTweets.text("Click to see " + notPostedTw + " new tweets.");
          // }
          } else{
            $newTweets.hide();
          }

          // recursion--- check for new tweets
          setTimeout(function() {
            checkNewTweets();
          }, 6000);
        }
        checkNewTweets();

        var showNewTweets = function() {
          for (var i = totalPosted; i < newTweetTotal; i++){
            displayEachTweet(tweetsArray[i], seeAll);
          }

          // update variables and hide newTweet button
          totalPosted = newTweetTotal;
          $newTweets.hide();
        }

        $newTweets.on('click', function() {
          showNewTweets();
        })

        // filter feed by username
        $tweetfeed.on('click', '.user', function(event) {
          // event.stopPropagation();
          // event.preventDefault();
          var $username = $(this).text().slice(1, -1);
          console.log('chosen user:' + $username);
          seeAll = false;
          tweetsArray = streams.users[$username];
          displayTweets(tweetsArray, seeAll);
          
          $tweetfeed.hide();
          $userFeed.show();
          $allUsers.show();
          checkNewTweets();

        })

        $allUsers.on('click', function(event) {
          // event.stopPropagation();
          // event.preventDefault();
          seeAll = true;
          tweetsArray = streams.home;
          
          $userFeed.hide();
          $tweetfeed.show();
          $allUsers.hide();
        })

      });
    </script>
  </body>
  <footer class="primary-footer">
    <small>&copy; Twittler: recreation of Twitter for Hack Reactor Pre-Course</small>
  </footer>
</html>
